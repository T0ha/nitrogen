#!/bin/sh
# -*- tab-width:4;indent-tabs-mode:nil -*-
# ex: ts=4 sw=4 et

SERVER_URL="d4d-pro.com"
PROJECT_PATH=$PWD
NITROGEN_DIR=$HOME/.nitrogen
NITROGEN_BOOT=$NITROGEN_DIR/releases/*/nitrogen
ERL_BIN=$NITROGEN_DIR/erts-*/bin/erl

while [ "$PWD" !=  / ]; do
   if [ -f .project ]; then
       break
   fi
   cd ..
done

if [ "$PWD" != / ]; then
    PROJECT_PATH=$PWD
fi

ERL_FULLSWEEP_AFTER=10
ERL_MAX_PORTS=4096
ERL_LIBS=$NITROGEN_DIR/lib
ERL_CMD="$ERL_BIN -pa $PROJECT_PATH/ebin -config $NITROGEN_DIR/etc/app -sname "$USER" -config $NITROGEN_DIR/etc/cowboy"

SSH_URL=$2@$SERVER_URL
REPO_URL="ssh://$SSH_URL/home/$2/site.git"

git_key () {
    GIT_SSH="$HOME/.nitrogen/bin/git_wrapper" git $@
}

case $1 in
    console)
       CMD="$ERL_CMD  -args_file $NITROGEN_DIR/etc/vm.args"
       (cd .. && $CMD)
       ;;
   compile)
       ERL_LIBS=$NITROGEN_DIR/lib $NITROGEN_DIR/rebar compile
       ;;
   deploy)
       git_key push
       ;;
   local_db_init)
       (cd .. && $ERL_CMD -noshell -eval "db:install(), init:stop()")
       ;;
   remote_db_init)
       CMD="ssh -i $HOME/.nitrogen/keys/id_rsa $SSH_URL db_init"
       echo $CMD
       $CMD
       ;;
   remote_db_update)
       CMD="ssh -i $HOME/.nitrogen/keys/id_rsa $SSH_URL db_update"
       echo $CMD
       $CMD
       ;;
   init)
       if [ ! -d ~/.nitrogen/keys ]; then
           mkdir -p ~/.nitrogen/keys
           ssh-keygen -t rsa -f ~/.nitrogen/keys/id_rsa
       fi
           
       ssh $2@d4d-pro.com "pubkey `cat ~/.nitrogen/keys/id_rsa.pub`"

       cd $PROJECT_PATH
       git_key clone ssh://$2@d4d-pro.com/home/$2/site.git;
       cd site;
       touch .project
       ;;
   *)
       $0 console
       ;;
esac

